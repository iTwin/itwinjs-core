# trigger:
#   branches:
#     include:
#       - master
#       - release/*
#     exclude:
#       - release/2*
#       - release/1*

trigger: none
pr: none

# Octopus requires release be of format 'x.y.z' or 'w.x.y.z'
name: $(Year:yyyy).$(Month).$(DayOfMonth).$(Rev:r)

# Pull in artifacts

resources:
  pipelines:
  - pipeline: itwinjs-docs
    source: iTwin.js Docs - YAML
    # version: 20221017.30
    trigger:
      branches:
        include:
        - master
        - release/*
        - docs-release-pipeline
        exclude:
        - release/2*
        - release/1*
      tags:
      - iTwinJsDocsRelease
  - pipeline: bemetalsmith-tests
    source: Bemetalsmith - Selenium Tests
  repositories:
  - repository: build-pipeline-scripts
    type: git
    name: iModelTechnologies/imodeljs-build-pipeline-scripts
    ref: refs/heads/docs-release-pipeline-templates
  - repository: bemetalsmith
    type: git
    name: iModelTechnologies/BeMetalsmith
    ref: refs/heads/master

variables:
  octopusProjectName: iModel.js Documentation

stages:
  - stage: CreateRelease
    displayName: Create release
    jobs:
    - template: ./jobs/docs/package-docs.yaml

  - stage: DEV
    displayName: Deployment (DEV)
    dependsOn: CreateRelease
    jobs:
    - template: ./jobs/docs/deploy-docs.yaml
      parameters:
        variableGroup: iTwin.js Docs - DEV

  - stage: ProductTestsDEV
    displayName: Product Tests (DEV)
    dependsOn: DEV
    jobs:
    - template: ./jobs/docs/product-tests.yaml
      parameters:
        env: Development

  - stage: QA
    displayName: Deployment (QA)
    dependsOn: ProductTestsDEV
    jobs:
    - template: ./jobs/docs/deploy-docs.yaml
      parameters:
        variableGroup: iTwin.js Docs - QA

  - stage: ProductTestsQA
    displayName: Product Tests (QA)
    dependsOn: QA
    jobs:
    - template: ./jobs/docs/product-tests.yaml
      parameters:
        env: QA

  - stage: LinkValidatorQA
    displayName: Link Validator (QA)
    dependsOn: QA
    jobs:
    - template: ./jobs/docs/validate-links.yaml
      parameters:
        env: QA

  - stage: UpdateDocumentationIndexQA
    displayName: Update Documentation Index (QA)
    dependsOn: QA
    jobs:
    - template: ./jobs/docs/update-docs-index.yaml
      parameters:
        variableGroup: iTwin.js Docs - Algolia - QA

  # - stage: ActiveScanQA
  #   displayName: Active Scan (QA)
  #   dependsOn: ProductTestsQA
  #   jobs:

  # - stage: Scorecard
  #   displayName: Scorecard
  #   dependsOn:
  #     - LinkValidatorQA
  #     - ProductTestsQA
  #   jobs:
  #   - template: templates/scorecard/docs-scorecard.yaml@build-pipeline-scripts
  #     parameters:
  #       gprId: 2947

  # - stage: PROD
  #   displayName: Deployment (PROD)
  #   dependsOn: Scorecard
  #   jobs:
  #   - template: ./jobs/docs/deploy-docs.yaml
  #     parameters:
  #       variableGroup: iTwin.js Docs - PROD

  # - stage: UpdateDocumentationIndexPROD
  #   displayName: Update Documentation Index (PROD)
  #   dependsOn: PROD
  #   jobs:
  #   - template: ./jobs/docs/update-docs-index.yaml
  #     parameters:
  #       variableGroup: iTwin.js Docs - Algolia - PROD
