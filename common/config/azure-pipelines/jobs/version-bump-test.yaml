# Test the mergify.yml version bump logic

trigger: none
pr: none

pool:
  vmImage: ubuntu-latest

jobs:
  - job: TestMergifyVersionBump
    displayName: Test Mergify Version Bump
    steps:
      - checkout: self

      - bash: |
          # After creating release branch, update mergify.yml on master with new branch variables
          git checkout master

          mergifyPath=".github/mergify.yml"
          newCurrentMinor="release/5.6.x"  # Simulate the new release branch name
          echo "Updating mergify.yml backport branches for $newCurrentMinor"

          # Get the current value of current_minor to move it to previous_minor
          # Find the line containing current_minor in mergify.yml
          currentMinorLine=$(grep "current_minor:" "$mergifyPath" | head -n 1)
          # Extract quoted string value from the line
          currentMinorValue=$(echo "$currentMinorLine" | sed -n 's/.*current_minor: &current_minor "\([^"]*\)".*/\1/p')

          # If there was no quoted string found, or if it is null, exit with error
          if [ -z "$currentMinorValue" ] || [ "$currentMinorValue" = "null" ]; then
            echo "Error: Unable to determine non-null current_minor value from $mergifyPath (line: $currentMinorLine)"
            exit 1
          fi
          echo "Moving current minor '$currentMinorValue' to previous minor and setting new current minor to '$newCurrentMinor'"

          # Handle both quoted strings and null values for previous_minor (matches both "value" and null)
          sed -ri "s|previous_minor: &previous_minor (\".*\"\|null)|previous_minor: \&previous_minor \"$currentMinorValue\"|" "$mergifyPath"
          sed -i "s|current_minor: &current_minor \".*\"|current_minor: \&current_minor \"$newCurrentMinor\"|" "$mergifyPath"

          # Show changes for verification
          echo "Updated mergify.yml content:"
          git diff "$mergifyPath"
          cat "$mergifyPath"
        displayName: Update mergify.yml variables on master
