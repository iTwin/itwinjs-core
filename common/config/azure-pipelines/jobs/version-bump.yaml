# The following build handles everything needed to bump the iTwin.js Core package versions
#
# There are currently 4 different types of version bumps:
#   - Nightly
#     - Move to the next `dev.x` version
#     - On master, occurs on a nightly basis, if there are changes to master since the last version bump
#     - On all other branches, can be triggered on-demand
#     - Can be run on any branch but normally used for `master` and `release/*` branches
#   - Release Candidate
#     - Only runs on the `master` branch
#     - Bumps the `dev.x` version on `master`, creates release branch and bumps `master` to the next minor dev version
#   - Minor
#     - Only runs on `release/*` branches
#     - Bumps the version to the next Minor version
#   - Patch
#     - Only runs on `release/*` branches
#     - Bumps the version to the next Patch version

trigger: none

pool:
  vmImage: ubuntu-latest

jobs:
  - job: Bump
    displayName: Bump Version
    steps:
      - checkout: self

      - task: UseNode@1
        displayName: Use Node 20.x
        inputs:
          version: 22.x
          checkLatest: true

      - bash: |
          git config --local user.email imodeljs-admin@users.noreply.github.com
          git config --local user.name imodeljs-admin
        displayName: Setup Git

      # - script: node common/scripts/install-run-rush.js install
      #   displayName: rush install

      # - bash: node common/scripts/install-run-rush.js audit
      #   displayName: rush audit

      - bash: node common/scripts/install-run-rush version --bump
        displayName: Rush version --bump

      - bash: |
          version=$(jq '.[] | .version' common/config/rush/version-policies.json)

          # Remove quotes or else vso task complains
          quotelessVersion=$(sed -e 's/^"//' -e 's/"$//' <<<"$version")
          echo "##vso[build.updatebuildnumber]iModel.js_$quotelessVersion"
          echo "##vso[task.setvariable variable=version;isOutput=true]$quotelessVersion"
        displayName: Get new version number
        name: getVersion

      - bash: "git add ."
        displayName: Git add

      - bash: |
          echo Committing version bump $(getVersion.version)...

          git commit -m "$(getVersion.version)" --author="imodeljs-admin <imodeljs-admin@users.noreply.github.com>"
        displayName: Commit version bump

      - bash: "git push --follow-tags https://$(GITHUBTOKEN)@github.com/iTwin/itwinjs-core HEAD:$(Build.SourceBranch)"
        displayName: Push version bump
