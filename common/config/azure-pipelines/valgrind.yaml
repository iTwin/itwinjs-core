# iTwin.js Valgrind Testing

trigger:
  branches:
    include:
      - master

jobs:
  - job:
    timeoutInMinutes: 120
    pool:
      name: iModelTechCI
      demands:
      - Agent.OS -equals Linux
      - Agent.Name -equals BuildMinion03L-A #only 03L-A and 03L-B have valgrind installed. There is no way to OR-combine demands, so we limit to this single machine
    variables:
      VALGRIND_RESULTS: $(Build.StagingDirectory)/valgrind-results/
    workspace:
      clean: all

    steps:
      - checkout: self
        clean: true

      - task: NodeTool@0
        displayName: "Use Node 14.17.4"
        inputs:
          versionSpec: 14.17.4
          checkLatest: true

      - script: |
          git config --local user.email imodeljs-admin@users.noreply.github.com
          git config --local user.name imodeljs-admin
        displayName: git config

      - script: node common/scripts/install-run-rush.js install
        displayName: rush install

      - script: node common/scripts/install-run-rush.js rebuild
        displayName: rush rebuild
        condition: succeeded()

      - script: mkdir $(VALGRIND_RESULTS)

      - script: 'valgrind --leak-check=full --track-origins=yes --gen-suppressions=all --trace-children=yes node common/scripts/install-run-rush.js cover |& tee $(VALGRIND_RESULTS)log-BeJsonCpp.txt'
        displayName: 'Run Valgrind on rush cover'
        failOnStderr: false

      - task: archiveandpublishartifact@0
        inputs:
          rootFolderOrFile: '$(VALGRIND_RESULTS)'
          archiveFolder: '$(Build.ArtifactStagingDirectory)'
          artifactName: 'ValgrindReport-$(Build.BuildId)'
