# iTwin.js Core Integration PR Validation Build
#
# This integration test job currently run on all supported Node Versions of iTwin.js.
# To decrease build load, only the latest Node version is tested on pull requests.
# All other versions are run on `master` and `release/*` branches.
#
# Note: Currently a subset of all integration tests
#

trigger:
  - master
  - release/*

pr:
  drafts: false
  branches:
    include:
      - master
      - release/*

variables:
  - group: iTwin.js non-secret config variables
  - group: iTwin.js Integration Test Users

jobs:
  - job: Node_14_x
    condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'))
    strategy:
      matrix:
        Linux_node_12_7:
          imageName: ubuntu-latest
          nodeVersion: 12.17.0
        Linux_node_12_x:
          imageName: ubuntu-latest
          nodeVersion: 12.x
        Linux_node_14_x:
          imageName: ubuntu-latest
          nodeVersion: 12.x
        # linux_node_16_x:
        #   imageName: ubuntu-latest
        #   nodeVersion: 16.x
        Windows_node_12_7:
          imageName: windows-latest
          nodeVersion: 12.17.0
        Windows_node_12_x:
          imageName: windows-latest
          nodeVersion: 12.x
        Windows_node_14_x:
          imageName: windows-latest
          nodeVersion: 12.x
        # Windows_node_16_x:
        #   imageName: windows-latest
        #   nodeVersion: 16.x
        MacOS_node_12_7:
          imageName: macos-latest
          nodeVersion: 12.17.0
        MacOS_node_12_x:
          imageName: macos-latest
          nodeVersion: 12.x
        MacOS_node_14_x:
          imageName: macos-latest
          nodeVersion: 12.x
        # MacOS_node_16_x:
        #   imageName: macos-latest
        #   nodeVersion: 16.x
    pool:
      vmImage: $(imageName)
    steps:
      - template: templates/integration-test-steps.yaml
        parameters:
          Node_Version: $(nodeVersion)

  # Pull request validation
  - job: Node_14_x
    condition: and(succeeded(), eq(variables['Build.Reason'], 'PullRequest'))
    pool:
      vmImage: ubuntu-latest
    steps:
      - template: templates/integration-test-steps.yaml
        parameters:
          Node_Version: 14.x
